# Network Traffic Analysis

This script performs network analysis to classify network traffic of Internet of Things (IoT) devices as either first, support, third, local, advertiser, or analytic party traffic. The script also determines the amount of unencrypted traffic and the destinations that this unencrypted traffic is being received from and sent to. Abroad analysis, which checks whether traffic is coming from abroad (this software assumes the user is based in the United States).

For step-by-step instructions on getting started, see the [Getting Started](Getting_Started.md) document.

## Setup

This script uses Python 3.6.

To setup this software, follow the directions in the [Setup](Getting_Started.md#setup) section of the Getting Started document.

## Usage

Usage: `python3 main.py -i PCAP_DIR -m MAC_ADDR {-s IMC_DIR | -v IN_CSV} [OPTION]...`

Example: `python3 main.py -i echodot_pcaps/ -m 18:74:2e:41:4d:35 -s ../intl-iot/ -c amazon -d org,sld -p PiePlot -n 4`

Example: `python3 main.py -i echodot_pcaps/ -m 18:74:2e:41:4d:35 -v echodot_tmp.csv -c amazon -n 4 -o echodot_results.csv`

## Input

There are several options to choose from, which are summarized below:

#### Required Arguments

`-i PCAP_DIR` - The path to the directory containing input pcap files for analysis. All the pcap files in this directory should have been generated by the same device.

`-m MAC_ADDR` - The MAC address of the device that generated the data in `PCAP_DIR`.

`-s IMC_DIR` - The path to the main directory (`intl-iot/`) containing the code accompanying the paper titled "Information Exposure From Consumer IoT Devices: A Multidimensional, Network-Informed Measurement Approach" in proceedings of the ACM Internet Measurement Conference 2019 (IMC'19). The code can be found here: https://github.com/dng24/intl-iot/. Destination analysis is performed using this code. **Either this option or the `-v` option is required.**

`-v IN_CSV` - The path to the output CSV filename of running destination analysis of the IMC'19 code on the pcap files in `PCAP_DIR`. **Either this option or the `-s` option is required.** If the CSV exists, it is recommended that this option be used instead of the `-s` option. If the CSV does not exist, use the `-s` option to generate the CSV.

#### Optional Arguments

`-c DEV_MFR` - The company that created the device that generated the data in `PCAP_DIR`. This is used to assist in the identification of first parties. Default is `unknown`.

`-r INTERVAL` - The interval, in milliseconds, between each ping sent to destinations in abroad analysis. Must be a positive integer. Default is `25`.

`-u COUNT` - The number of pings to send to each destination in abroad analysis to determine the time it takes to contact that destination. Must be a positive integer. Default is `5`.

`-t TIME_RNG` - The time range in number of days to split the data into for longitudinal analysis. The time range can be fractions of a day. Default is `1`. **Longitudinal analysis currently not implemented.**

`-f FIG_DIR` - The path to the directory where generated plots and other associated output will be placed. If this directory does not currently exist, it will be generated by the script. Default is `plots/`.

`-o OUT_CSV` - The path to the output CSV file where the analysis will be written. If the file does not exist, it will be generated. If it exists, the results will be appended. Default is `results.csv`.

`-d DST_TYPS` - A comma-separated list of destination types to use as data to generate plots. Choose from `fqdn`, `org`, and `sld`. **This option must be used with the `-p` option.**

`-p PLT_TYPS` - A comma-separated list of plot types to use as the visual format to generate plots. Choose from `BarHPlot` and `PiePlot`. **This option must be used with the `-d` option.**

`-l` - Generate plots using `DST_TYPS` and `PLT_TYPS` linearly instead of in a 2D-array-like style. See below for more information.

`-e DPI` - The DPI (dots per inch) of the plots. Must be an integer. Default is `72`.

`-n NUM_PROC` - The number of CPU processes to use to run the destination analysis portion. Must be a positive integer. Default is `1`.

`-h` - Print the usage statement and exit.

#### Notes on the Plots

- The `-d` and the `-p` options must be used together to generate plots, as they specify different configurations of a plot.

- The `-d` option specifies the destination types to use as data in the plots. The following types are currently available:
  - Fully-Qualified Domain Name (fqdn)
  - Organization (org)
  - Second-Level Domain (sld)

- The `-p` option specifies the plot types to use as visuals in the plots. The following types are currently available:
  - BarHPlot
  - PiePlot

- The `-l` option specifies how the `-d` and the `-p` options should be combined to create plots. If the `-l` option is specified, the `-d` and `-p` options are combined in a linear style. If it is not specified, the options are combined in a 2D-array style.
  
  Example: The `-d` option is `org,sld`, and the `-p` option is `BarHPlot,PiePlot`. The following sets of plots are created if
  - the `-l` option is specified:
    - a set of `BarHPlot` using `org` data
    - a set of `PiePlot` using `sld` data
  - the `-l` option is not specified:
    - a set of `BarHPlot` using `org` data
    - a set of `BarHPlot` using `sld` data
    - a set of `PiePlot` using `org` data
    - a set of `PiePlot` using `sld` data

- If the `-l` option is specified and the `-d` and `-p` options differ in the number of items, plots will be generated up until one list runs out of items.
  
  Example: The `-d` option is `org,sld`, and the `-p` option is `PiePlot`. Only a set of `PiePlot` using `org` data is generated.

- The `-t` option can be used to set the DPI of the plots.

## Output

When `main.py` is run, several files are outputted.

### Main CSV Output

The main output is generated by the `-o` option. This CSV file contains an analysis of traffic in the input pcap files. There are eleven columns of analysis:

- `ip` - The IP address of the packets being analyzed.
- `host` - The second level domain name of an IP address.
- `host_full` - The full domain name, including any subdomains.
- `traffic_snd` - The number of bytes of packets sent.
- `traffic_rcv` - The number of bytes of packets received.
- `packet_snd` - The number of packets sent.
- `packet_rcv` - The number of packets received.
- `country` - The country code that the IP address belongs to. If not found, `XX` is displayed.
- `party` - The party that the traffic belongs to. Either first, support, third, local, advertiser, or analytic party.
- `input_file` - The path of the input pcap file that contained the traffic being analyzed.
- `organization` - The organization that the IP address belongs to. If not found, `N/A` is displayed.
- `protocol&port` - The protocol and port of a packet.
- `encryption` - The encryption state of a packet. Either encrypted, unencrypted, or unknown.

### Generated Plots

Several plots can be produced for visualization. Plots are generated based on the `-d`, `-p`, `-l`, and `-t` options. Directories are generated to organize the plots. The directory structure is `<FIG_DIR>/<analysis_type>/<plot_type>/<dst_type>/<plot_name>.png`.

#### Party Analysis

- One set of plots, with the format `<DEV_MFR>_device_parties_<plot_type>_<dst_type>.png`, shows the percentage of first, support, third, local, advertiser, and analytic party traffic from the input pcap files. These plots also shows the number of bytes of traffic from each party.

- For each party, plots in the format `<DEV_MFR>_<plot_type>_<dst_type>_<party>_party_traffic.png` are produced. They show the domain names and the percentage of traffic from each domain. If a party does not have traffic, no graphs are produced for that party.

#### Encryption Analysis

- For pie plots, a set of plots in the format `<DEV_MFR>_pie_<dst_type>_encryption_traffic.png` are produced. They show the percentage of traffic that is sent encrypted and the percentage of traffic that is sent unencrypted.

- For horizontal bar plots, plots in the format `<DEV_MFR>_bar_<dst_type>_unencrypted_traffic.png` are produced. They show the destinations of the unencrypted traffic and the amount of traffic being sent to and received from each destination.

#### Abroad Analysis

- A set of plots named `<DEV_MFR>_<plot_type>_<dst_type>_abroad_traffic.png` are produced. They show the percentage of traffic that sent traffic abroad and the domain names of the abroad traffic.

### Other Files Generated

- A file, named `<OUT_CSV>_destinations.pkl` is generated. It contains the data of all three analyses. If a command is run again, the three analyses are skipped, as the results are contained in this file, and the plots are produced right away. To rerun the analysis, delete this file.

- A text file, named `<DEV_MFR>_all_<dst_type>.txt`, which lists the specified data by party is produced. This file can be found in the plot directory structure.

- A text file, named `<DEV_MFR>_ping_result.txt` can be found in the directory named `<FIG_DIR>_country_analysis/`. This tab-delimited text file lists each IP pinged along with the minimum time of five pings sent to the destination. A result of `FAILED` means the destination could not be pinged.

- If the `-s` option is used, a CSV file, named `<DEV_MFR>_tmp.csv`, which is a temporary file containing the output of running the destination analysis from the IMC'19 software is also generated. This file can be found in `FIG_DIR`.

