# neu_mon-iot-_network_traffic_analysis

This script performs network analysis to classify traffic as either first, support, third, local, advertiser, or analytic party traffic. The script also determines the amount of unencrypted traffic and the destinations that this unencrypted traffic is being received from and sent to.

## Setup

This script uses Python 3.

The following dependencies need to be installed:

```
pip install adblockparser
apt install whois
```

## Usage
Usage: `python3 main.py -i PCAP_DIR -m MAC_ADDR -s IMC_DIR [OPTION]...`

Example: `python3 main.py -i echodot_pcaps/ -m 18:74:2e:41:4d:35 -s ../intl-iot/ -c amazon -d org,sld -p PiePlot -n 4`

## Input

There are several options to choose from, which are summarized below:

#### Requried arguments:

`-i PCAP_DIR` - The path to the directory containing input pcap files for analysis. All the pcap files in this directory should have been generated by the same device.

`-m MAC_ADDR` - The MAC address of the device that generated the data in `PCAP_DIR`.

`-s IMC_DIR` - The path to the main directory (`intl-iot/`) containing the code accompanying the paper titled "Information Exposure From Consumer IoT Devices: A Multidimensional, Network-Informed Measurement Approach" in proceedings of the ACM Internet Measurement Conference 2019 (IMC 2019). The code can be found here: https://github.com/NEU-SNS/intl-iot. Destination analysis is performed using this code.

#### Optional arguments:

`-c DEV_MFR` - The company that created the device that generated the data in `PCAP_DIR`. This is used to identify the first parties. Default is `unknown`.

`-f FIG_DIR` - The path to the directory where generated plots and other associated output will be placed. If this directory does not currently exist, it will be generated by the script. Default is `plots/`.

`-o OUT_CSV` - The path to the output CSV file containing the analysis. If the file does not exist, it will be generated. If it exists, the results will be appended. Default is `results.csv`.

`-d DST_TYPS` - A comma-separated list of destination types to use as data to generate party analysis plots. Choose from `fqdn`, `org`, and `sld`.

`-p PLT_TYPS` - A comma-separated list of plot types to use as the visual format to generate party analysis plots. Choose from `BarHPlot` and `PiePlot`.

`-l` - Generate plots using `DST_TYPS` and `PLT_TYPS` linearly instead of in a 2D-array-like style.

`-n NUM_PROC` - The number of CPU processes to use to run the destination analysis portion. Default is 1.

`-h` - Print the usage statement and exit.

#### Notes on the Party Analysis Plots

- The `-d` and the `-p` options must be used together to generate party analysis plots, as they specify different configurations of a plot.

- The `-d` option specifies the destination types to use as data in the plots. The following types are currently available:
  - Fully-Qualified Domain Name (fqdn)
  - Organization (org)
  - Second-Level Domain (sld)

- The `-p` option specifies the plot types to use as visuals in the plots. The following types are currently available:
  - BarHPlot
  - PiePlot

- The `-l` option specifies how the `-d` and the `-p` options should be combined to create plots. If the `-l` option is specified, the `-d` and `-p` options are combined in a linear style. If it is not specified, the options are combined in a 2D-array style.
  Example: The `-d` option is `org,sld`, and the `-p` option is `BarHPlot,PiePlot`. The following sets of plots are created if
  - the `-l` option is specified:
    - a set of `BarHPlot` using `org` data
    - a set of `PiePlot` using `sld` data
  - the `-l` option is not specified:
    - a set of `BarHPlot` using `org` data
    - a set of `BarHPlot` using `sld` data
    - a set of `PiePlot` using `org` data
    - a set of `PiePlot` using `sld` data

- If the `-l` option is specified, and the `-d` and the `-p` options differ in the number of items, plots will be generated up until one list runs out of items.
  Example: The `-d` option is `org,sld`, and the `-p` option is `PiePlot`. Only a set of `PiePlot` using `org` data is generated.

## Output

When `main.py` is run, several files are outputted.

### Main CSV Output

The main output is generated by the `-o` option. This CSV file contains an analysis of traffic in the input pcap files. There are eleven columns of analysis:

- `ip` - The IP address of the packets being analyzed.
- `host` - The second level domain name of an IP address.
- `host_full` - The full domain name, including any subdomains.
- `traffic_snd` - The number of bytes of packets sent.
- `traffic_rcv` - The number of bytes of packets received.
- `packet_snd` - The number of packets sent.
- `packet_rcv` - The number of packets received.
- `country` - The country code that the IP address belongs to. If not found, `XX` is displayed.
- `party` - The party that the traffic belongs to. Either first, support, third, local, advertiser, or analytic party.
- `input_file` - The name of the input pcap file that contained the traffic being analyzed.
- `organization` - The organization that the IP address belongs to. If not found, `N/A` is displayed.
- `protocol&port` - The protocol and port of a packet.
- `encryption` - The encryption state of a packet. Either encrypted, unencrypted, or unknown.

### Generated Plots

Several plots can be produced for visualization. Graphs for party analysis are generated based on the `-d`, `-p`, and `-l` options. Graphs for encryption analysis are automatically created.

#### Party Analysis

- One graph, named `<DEV_MFR>_device_parties_<plot_type>_<dest_data_type>.png`, shows the percentage of first, support, third, local, advertiser, and analytic party traffic from the input pcap files. The graph also shows the number of bytes of traffic from each party.

- For each party, a graph named `<DEV_MFR>_<plot_type>_<dest_data_type>_<party>_party_traffic.png` is produced. It shows the domain names and the percentage of traffic from that domain. If a party does not have traffic, no graph is produced for that party.

#### Encryption Analysis

- A graph called `<DEV_MFR>_traffic_encryption.png` is also produced. It shows the percentage of traffic that is encrypted and the percentage of traffic that is unencrypted.

- Another graph named `<DEV_MFR>_unencrypted_traffic_dst.png` shows the destinations of the unencrypted traffic and the amount of traffic being sent to and received from each destination.

- For each party, a graph named `<DEV_MFR>_unencrypted_<party>.png` is produced, showing the domain names of unencrypted traffic for that party and the percentage of unencrypted traffic coming from that domain for the party. If a party does not have traffic, no graph is produced for that party. 

### Other Files Generated

- A text file, named `<DEV_MFR>_all_<dest_data_type>.txt`, which lists the specified data by party is produced.

- A CSV file, named `<DEV_MFR>_tmp.csv`, which is a temporary file containing the output of running the destination analysis from the IMC'19 software is also generated.

